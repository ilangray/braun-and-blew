<!DOCTYPE html>
<html>
<head>
<style type="text/css">
canvas{
   padding: 0 27% 2% 23%;
}
#intro{
    line-height: 2;
    text-align: left;
}
h2{
    font-family: "Arial";
    line-height: 0.3;
    padding: 0 25% 0 25%;
    text-align: center;
}

h2{
    padding-top: 0%;
}

p{
    font-size:0.9em;
    text-align: center;
}

button{
    width: 80px;
    height: 20px;
}

#buttons{
   margin-left:44%;

}

footer{
   font-size:10px;
}

img{
    margin-left:42%;
    text-align: center;
}

</style>

</head>
<body>
<h2 id="title"> People Are Liars </h2>
<p id="story">We found a graph online showing the correlation between per-capita gun ownership and gun deaths. Here is the data he used, in our graph. Note that the red circle is the US.</p>
<canvas class = "canvas" id = "canvas1"></canvas>
<div id = "buttons">
   <button id = "pre" onclick = "decrease()"> Previous </button>
   <button id = "next" onclick = "increase()"> Next </button>
</div>
<footer>
   <p> comp 150-07(VIZ), Lab 2: Story telling </p>
</footer>
<script src = "http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<script src = "http://processingjs.org/js/processing.min.js"></script>
<script type = "text/javascript" src="http://d3js.org/d3.v3.min.js"></script>
<script type="text/javascript" src="http://underscorejs.org/underscore-min.js"></script>

<script>

var STORIES = [
	"We found a graph online showing the correlation between per-capita gun ownership and gun deaths. Here is the data he used, in our graph. Note that the red circle is the US.",

	"We add a best fit line to show the correlation that the author was trying to demonstrate",

	"Here is the full dataset provided by Wikipedia, where he claimed to get his data from. As you can see, he pulled a fast one."
];


var intColor = 0;
var mode = 0;

// the whole contents and nothing but the contents
var result;

var brokenData;
var currentData;

// array of points
var BEST_FIT_LINE;
var INVALID_LINE = [{x: -10, y: 0}, {x: -10, y: 0}];
var line = INVALID_LINE;

d3.csv("deathsGuns.csv", function(d){
	return {
		country: d.Country,
		deaths: +d.Deaths,
		guns: +d.Guns,
	  };		
}, function(err, d){
	// console.log("Data = ", JSON.stringify(d, null, 4));

	if(err) return console.log('Oops! csv died.');
	result = d;

	brokenData = _.filter(result, function (d) {
		if (d.country == "United States" || d.country == "Mexico") {
			return true;
		}

		if (d.deaths > 3 && d.guns < 30) {
			return false;
		}

		return d.deaths < 7;
	});

	currentData = brokenData;

	run(result);
});

function run(result) {
	$("story").text(STORIES[mode]);
	var canvas = document.getElementById("canvas1");
	var processingInstance = new Processing(canvas, sketchProc); 
}
	 
function increase(){
	mode += 1;
	setPhase(mode);
	run(result);
}

function decrease(){
	mode -= 1;
	setPhase(mode);
	run(result);
}

function setPhase(phase) {
	line = phase == 1 ? BEST_FIT_LINE : INVALID_LINE;

	console.log("setting phase = ", phase);
	$("#story").text(STORIES[phase]);

	currentData = phase <= 1 ? brokenData : result;
}

function sketchProc(p) {	
	var margin = 100, iWidth = 600, iHeight = 400;
   
	p.setup = function(){ 
		p.size(iWidth + 2 * margin, iHeight + 2 * margin, p.P2D);
		$("#canvas1").css("width","" + p.width);
		$("#canvas1").css("height","" + p.height);
		p.smooth();   	 
		p.rectMode(p.CORNER);
		p.ellipseMode(p.RADIUS);

		BEST_FIT_LINE = [
			getO(),
			getPointForDatum(brokenData, {
				"guns": 88.8,
				"deaths": 9
			})
		];
	}

	p.draw = function() {
		p.background(p.color(250));

		drawAxis();
		markAxis();
		drawData();
		drawLine();
	};

	function getMaxX(ds) {
		return _.max(ds, "guns").guns;
	}

	function getMaxY(ds) {
		return _.max(ds, "deaths").deaths;
	}

  	function getO() {
  		return {
  			"x": margin,
  			"y": iHeight
  		}
  	}

  	function getLR() {
  		return {
  			"x": margin + iWidth,
  			"y": iHeight
  		}
  	}

  	function getUL() {
  		return {
  			"x": margin,
  			"y": margin,
  		}
  	}

  	function drawLine() {
  		p.fill(p.color(0, 0, 0));
  		p.line(line[0].x, line[0].y, line[1].x, line[1].y);
  	}
  	
  	function drawAxis() {
  		var o = getO();
  		var lr = getLR();
  		var ul = getUL();

  		p.line(o.x, o.y, lr.x, lr.y);
  		p.line(ul.x, ul.y, o.x, o.y);

		p.textAlign(p.CENTER);
		p.fill(p.color(0, 0, 0));
  		p.text("Deaths/100k", ul.x, ul.y - 10);
  		p.text("Guns/100", lr.x + margin/2, lr.y);
  	}

  	function markAxis() {
  		var lr = getLR();
  		var ul = getUL();

  		p.text(getMaxX(), lr.x, lr.y + 15);
  		p.text(getMaxY(), ul.x - 30, ul.y + 15);
  	}

  	function getX(data, val) {
  		var percent = val / getMaxX(data);
  		var xDist = getLR().x - getO().x;

  		return getO().x + percent * xDist;
  	}

  	function getY(data, val) {
  		var percent = val / getMaxY(data);
  		var yDist = getLR().y - getUL().y;

  		return getO().y - percent * yDist;
  	}

  	function getPointForDatum(data, datum) {
  		return {
  			x: getX(data, datum.guns),
  			y: getY(data, datum.deaths)
  		};
  	}

  	function drawData() {
  		_.each(currentData, function (datum) {
  			var center = getPointForDatum(currentData, datum);

  			p.fill(p.color(0, 0, 0));
  			var radius = 3;
  			if (datum.country == "United States") {
  				radius = 10;
  				p.fill(p.color(255, 0, 0))
  			}

  			p.ellipse(center.x, center.y, radius, radius);
  		});
  	}

   function step0(){
	   // $()s are jQuery code. 
	   $("#title").css("padding-top","10%");
	   $("#pre").prop("disabled",true);
	   $("#next").prop("disabled",false);
	   
	   // $("#intro").css("padding-left", "40%");
	   // $("#intro").show();
    //    $("#poster").show();
       
	   // $("#intro").text("Step 0");
    //    $("#p1").hide();
    //    $("#p2").hide();
    //    $("#p3").hide();
   }
   
   function step1(){
       $("#poster").hide();
       $("#canvas1").show();
	   $("p").show();
	   
	   $("#intro").hide();	   
	   
	   $("#pre").prop("disabled",false);
	   $("#next").prop("disabled",false);
	     
	   // The example to write processing.js code in Javasript
	   p.textAlign(p.CENTER);
	   // The example to use teh "result dataset"
	   p.text(result[0].Title, p.width / 2.0, p.height / 3.0);
	   p.text("I'm dying!!!!!!!", p.width / 2.0, p.height / 3.0 - 20);
	   // I'm calling local JavaScript function here
	   cat(p.width / 2.0 + Math.random() * 50, p.height / 2.0 + Math.random() * 10, 30, Math.random());
	   $("#p1").text("p1");
	   $("#p2").text("p2");
	   $("#p3").text("p3");		   
   }
   
   function step2(){
	   $("#pre").prop("disabled",false);
	   $("#next").prop("disabled",true);
	   
	   cat(p.width / 2.0, p.height / 2.0, 50, Math.random() * 10);
	   
	   $("#p1").text("p1");
	   $("#p2").text("p2");
	   $("#p3").hide();   
   }
   
   function cat(x, y, size, random){   
	   var headSize = size * 2 / 3, earSize = size * 0.4, eyeSize = (size * 0.005 - 1 > 0)? (size * 0.005) : 1;
	   p.noStroke();
	   p.triangle(x - earSize * 2, y - size * 0.15, x - earSize , y - size * 0.45, x - 1.5 * earSize, y - size * 0.15 - p.sqrt(3) * earSize);
       p.triangle(x + earSize * 2, y - size * 0.15, x + earSize , y - size * 0.45, x + 1.5 * earSize, y - size * 0.15 - p.sqrt(3) * earSize);
	   p.ellipse(x, y + 1 / 4 * size, headSize / ( 3 / 4 ) , headSize); // head
	   p.stroke(p.color(0));
	   p.strokeWeight(size * 0.2);
	   p.fill(p.color(0));
	   if(!random){
		   random = 0;
	   }
	   p.bezier(x - headSize , y + 1 / 2 * size,  
			   x - 1 * headSize,  y + 2 /2 * size,
			   x - 2 * headSize,  y + 1 /2 * size + random,
			   x - 3 * headSize,  y + 2 /2* size + random); // head
    }
   }


 </script>
 
</body>
</html>
